<!DOCTYPE html>
<html>
<head>
	<title>Tilehut Map Preview</title>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.css"/>
	<style type="text/css">
		body { margin: 0; padding: 0; }
		#map { position:absolute; top:0; bottom:0; width:100%; }
		#hover{ font-family: Sans-Serif;
				width: 300px;
				position: absolute;
				top: 40px;
				right: 40px;
				color: #2C2C2C;
				background: white;
				border: 2px solid #464646;
		}

		dl{
			display: inline;
		}

		dt{
			clear: left;
		}

		dd{
			clear: right;
		}

		dd, dt{
			width: 45%;
			float: left;
			margin: 0;
			padding: 15px 0 12px 5%;
			border-bottom: 1px solid rgb(219, 219, 219);
		}

	</style>
</head>
<body>
	<div id="map"></div>
	<div id="hover">Hover over a feature</div>
	<script src="https://code.jquery.com/jquery-2.1.1.min.js"></script>
	<script src="http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.js"></script>
	<script src="http://danzel.github.io/Leaflet.utfgrid/src/leaflet.utfgrid.js"></script>
	<script src='https://api.tiles.mapbox.com/mapbox-gl-js/v0.3.0/mapbox-gl.js'></script>

	<script>
		var map;

		function createMapFromType(type,meta){
			switch (type){
				case 'raster':
					createRasterMap(meta);
				break;
				case 'raster-utf8':
					createRasterMap(meta);
					addUTF8Grid();
				break;
				case 'vector':
					createVectorMap(meta);
				break;
				default:
					alert('type of map could not be detected â€“ check your meta.json file');
			}
		}

		function createRasterMap(meta){
			map = L.map('map')
				, center = meta.center.slice(0,2).reverse()
				, tilesetUrl = window.location.href.split("map")[0]
				, tilesLayer = L.tileLayer(tilesetUrl+'{z}/{x}/{y}.png', {
					minZoom: meta.minzoom,
					maxZoom: meta.maxzoom,
				});
			map.setView(center, meta.maxzoom);
			map.addLayer(tilesLayer);
		}

		function addUTF8Grid(){
			$('#hover').show();
			var tilesetUrl = window.location.href.split("map")[0];
			var utfGrid = new L.UtfGrid(tilesetUrl+'{z}/{x}/{y}.grid.json', {
				useJsonP: false //because .grid.json is a json file, not jsonp
			});
			map.addLayer(utfGrid);

			// if hovering above the map
			utfGrid.on('mouseover', function (e) {
				if (e.data) {
					var html = "<dl>";
					var obj = e.data;
					Object.getOwnPropertyNames(obj).forEach(function(val, idx, array) {
						html  += "<dt>\"" + val + "\":</dt><dd>\"" + obj[val] + "\"</dd>";
					});
					html += "</dl>"

					document.getElementById('hover').innerHTML = html;
				} else {
					document.getElementById('hover').innerHTML = 'Hover over a feature';
				}
			});
		}

		function createVectorMap(meta){
			var tilesetUrl = window.location.href.split("map")[0];
			var style = {
				  "version": 5,
				  "sources": {
				    "mapbox": {
				      "type": "vector",
				      "url": "" + tilesetUrl + "meta.json?vectortileflag=true",
				      "maxzoom": 15
				    }
				  },
				  "layers": [
					  {
					    "id": "background",
					    "style": {
					      "background-color": "#C5D1ED"
					    },
					    "type": "background"
					  },
					  {
					    "source": "mapbox",
					    "source-layer": "admin-countries",
					    "style": {
					      "fill-color": "#EDF0FD",
					      "fill-outline-color": "#FCFCFF"
					    },
					    "type": "fill"
					  }
				  ]
			};

			// create a map in the "map" div, center the view at a given place, set initial zoom level, reference to style
			var center = meta.center.slice(0,2).reverse();
			map = new mapboxgl.Map({
			    container: 'map',
			    center: center,
			    zoom: meta.maxzoom,
			    style: style, //stylesheet location
			    hash: true	//adds zoom level and coordinates in the url (e.g. http://localhost:8080/#3.84/58.63/43.81)
			});
		}

		function getMapType(meta){
			if( jQuery.isEmptyObject( meta.vector_layers ) ){
				if( jQuery.isEmptyObject( meta.template )) {
					console.log('detected map is raster');
					return 'raster'
				}else{ 
					console.log('detected map is raster utf8');
					return 'raster-utf8'
				}
			}else{
				console.log('detected map is vector');
				return 'vector'
			}
			console.log('map type could not be detected');
			return 'meta file has wrong structure'
		}

		$(document).ready(function() {
			$.getJSON("../meta.json")
			.done(function(meta) {
				var type = getMapType(meta);
				createMapFromType( type, meta );
			})
			.fail(function() {
		    	console.error("can't load tileset meta infos")
		    });
		});
	</script>
</body>
</html>
