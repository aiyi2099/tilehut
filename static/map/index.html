<!DOCTYPE html>
<html>
<head>
	<title>Tilehut Map Preview</title>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.css"/>
	<style type="text/css">
		body { margin: 0; padding: 0; }
		#map { position:absolute; top:0; bottom:0; width:100%; }
		#hover{ font-family: Sans-Serif;
				position: absolute;
				top: 18px;
				left: 80px;
				color: #2C2C2C;
				background: white;
				padding: 10px 25px;
				border: 2px solid #8DC9D6;
				border-radius: 4px;
				display: none;
		}
	</style>
</head>
<body>
	<div id="map"></div>
	<div id="hover">Hover over a country</div>
	<script src="https://code.jquery.com/jquery-2.1.1.min.js"></script>
	<script src="http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.js"></script>
	<script src="http://danzel.github.io/Leaflet.utfgrid/src/leaflet.utfgrid.js"></script>
	<script>
		function createMapFromType(type,meta){
			switch (type){
				case 'raster':
					createRasterMap(meta);
				break;
				case 'utf8':
					createUtf8Map(meta);
				break;
				case 'vector':
					createVectorMap(meta);
				break;
				default:
					alert('type of map could not be detected â€“ check your meta.json file');
			}
		}

		function createRasterMap(meta){
			var map = L.map('map')
				, center = meta.center.slice(0,2).reverse()
				, tilesetUrl = window.location.href.split("map")[0]
				, tilesLayer = L.tileLayer(tilesetUrl+'{z}/{x}/{y}.png', {
					minZoom: meta.minzoom,
					maxZoom: meta.maxzoom,
				});
			map.setView(center, meta.maxzoom);
			map.addLayer(tilesLayer);
		}


		function createUtf8Map(meta){
			$('#hover').show();
			var map = L.map('map')
				, center = meta.center.slice(0,2).reverse()
				, tilesetUrl = window.location.href.split("map")[0]
				, tilesLayer = L.tileLayer(tilesetUrl+'{z}/{x}/{y}.png', {
					minZoom: meta.minzoom,
					maxZoom: meta.maxzoom,
				});

			var utfGrid = new L.UtfGrid(tilesetUrl+'{z}/{x}/{y}.grid.json', {
				useJsonP: false
			});

			map.setView(center, meta.maxzoom);
			map.addLayer(tilesLayer);
			map.addLayer(utfGrid);

			// if hovering above the map
			utfGrid.on('mouseover', function (e) {
				if (e.data) {
					document.getElementById('hover').innerHTML = e.data;
				} else {
					document.getElementById('hover').innerHTML = 'Hover over a feature';
				}
			});
		}

		function createVectorMap(meta){
		}

		function getMapType(meta){
			if( jQuery.isEmptyObject( meta.vector_layers ) ){
				if( jQuery.isEmptyObject( meta.template )) {
					console.log('detect map is raster');
					return 'raster'
				}else{ 
					console.log('detect map is raster utf8');
					return 'utf8'
				}
			}else{
				console.log('detect map is vector');
				return 'vector'
			}
			console.log('map type coul not be detected');
			return 'meta file has wrong structure'
		}

		$(document).ready(function() {
			$.getJSON("../meta.json")
			.done(function(meta) {
				var type = getMapType(meta);
				createMapFromType( type, meta );
			})
			.fail(function() {
		    	console.error("can't load tileset meta infos")
		    });
		});
	</script>
</body>
</html>
