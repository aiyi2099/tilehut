<!DOCTYPE html>
<html>
<head>
	<title>Tilehut Map Preview</title>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.css"/>
	<style type="text/css">
		body { margin: 0; padding: 0; }
		#map { position:absolute; top:0; bottom:0; width:100%; }
		#inspector{ font-family: Sans-Serif;
				width: 300px;
				position: absolute;
				top: 40px;
				right: 40px;
				color: #2C2C2C;
				background: white;
				border: 2px solid #464646;
				display: none;
		}

		dl{ display: inline; }
		dt{ clear: left; }
		dd{ clear: right; }
		dd, dt{
			width: 45%;
			float: left;
			margin: 0;
			padding: 15px 0 12px 5%;
			border-bottom: 1px solid rgb(219, 219, 219);
		}

	</style>
</head>
<body>
	<div id="map"></div>
	<div id="inspector">Hover over a feature</div>

	<script src="https://code.jquery.com/jquery-2.1.1.min.js"></script>
	<script src="http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.js"></script>
	<script src="http://danzel.github.io/Leaflet.utfgrid/src/leaflet.utfgrid.js"></script>
	<script src='https://api.tiles.mapbox.com/mapbox-gl-js/v0.3.0/mapbox-gl.js'></script>
	<script>
		

		function init(meta){
			var map;
			var mapDiv = 'map';
			var tilesetUrl = window.location.href.split("map")[0];
			var tilesetCenter = meta.center.slice(0,2).reverse()
			var tilesetMaxZoom = meta.maxzoom;
			var tilesetMinZoom = meta.minzoom;
			var tilesLayer = L.tileLayer(tilesetUrl+'{z}/{x}/{y}.png', {
				minZoom: tilesetMinZoom,
				maxZoom: tilesetMaxZoom,
			});
			var tilesetType = getMapType(meta);

			var mapStyle = {
				  "version": 5,
				  "sources": {
				    "mapbox": {
				      "type": "vector",
				      "url": "" + tilesetUrl + "meta.json?vectortileflag=true",
				      "minzoom": tilesetMinZoom,
				      "maxzoom": tilesetMaxZoom
				    }
				  },
				  "layers": [
					  {
					    "id": "background",
					    "style": {
					      "background-color": "#C5D1ED"
					    },
					    "type": "background"
					  },
					  {
					    "source": "mapbox",
					    "source-layer": "admin-countries",
					    "style": {
					      "fill-color": "#EDF0FD",
					      "fill-outline-color": "#FCFCFF"
					    },
					    "type": "fill"
					  }
				  ]
			};

			createMapFromType( tilesetType, mapDiv, tilesetCenter, tilesetUrl, tilesLayer, mapStyle, tilesetMaxZoom);
		}

		function createMapFromType(tilesetType, mapDiv, tilesetCenter, tilesetUrl, tilesLayer, mapStyle, tilesetMaxZoom){
			switch (tilesetType){
				case 'raster':
					createRasterMap(mapDiv, tilesetCenter, tilesLayer, tilesetMaxZoom);
				break;
				case 'raster-utf8':
					createRasterMap(mapDiv, tilesetCenter, tilesLayer, tilesetMaxZoom);
					addUTF8Grid(tilesetUrl);
				break;
				case 'vector':
					createVectorMap( mapDiv, tilesetCenter, mapStyle, tilesetMaxZoom);
				break;
				default:
					alert('type of map could not be detected â€“ check your meta.json file');
			}
		}

		function createRasterMap(mapDiv, tilesetCenter, tilesLayer, initialZoom){
			map = L.map( mapDiv );
			map.setView(tilesetCenter, initialZoom);
			map.addLayer(tilesLayer);
		}

		function addUTF8Grid(tilesetUrl){
			$('#inspector').show();

			var utfGrid = new L.UtfGrid(tilesetUrl+'{z}/{x}/{y}.grid.json', {
				useJsonP: false //because .grid.json is a json file, not jsonp
			});
			map.addLayer(utfGrid);

			// if hovering above the map
			utfGrid.on('mouseover', function (e) {
				var obj = e.data;
				if ( obj ) {

					var html = "<dl>";
					Object.getOwnPropertyNames(obj).forEach(function(val, idx, array) {
						html  += "<dt>\"" + val + "\":</dt><dd>\"" + obj[val] + "\"</dd>";
					});
					html += "</dl>"

					$('#inspector').html( html );
				} else {
					$('#inspector').html( 'Hover over a feature' );
				}
			});
		}

		function createVectorMap(mapDiv, tilesetCenter, mapStyle, initialZoom){
			// create a map in the "map" div, center the view at a given place, set initial zoom level, reference to style
			map = new mapboxgl.Map({
			    container: mapDiv,
			    center: tilesetCenter,
			    zoom: initialZoom,
			    style: mapStyle, //stylesheet location
			    hash: true	//adds zoom level and coordinates in the url (e.g. http://localhost:8080/#3.84/58.63/43.81)
			});
		}

		function getMapType(meta){
			if( jQuery.isEmptyObject( meta.vector_layers ) ){
				if( jQuery.isEmptyObject( meta.template )) {
					console.log('detected map is raster');
					return 'raster';
				}else{ 
					console.log('detected map is raster utf8');
					return 'raster-utf8';
				}
			}else{
				console.log('detected map is vector');
				return 'vector';
			}
			console.log('map type could not be detected');
			return 'meta file has wrong structure';
		}

		$(document).ready(function() {
			$.getJSON("../meta.json")
			.done(function(meta) {
				init(meta);
			})
			.fail(function() {
		    	console.error("can't load tileset meta infos")
		    });
		});
	</script>
</body>
</html>
